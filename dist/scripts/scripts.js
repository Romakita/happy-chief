"use strict";angular.module("happyChiefApp",["ngCookies","ngResource","ngSanitize","ngRoute","mm.foundation"]).config(["$routeProvider",function(a){a.when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/auth/:json",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/recipes/:id",{templateUrl:"views/recipe.html",controller:"RecipeCtrl"}).when("/recipes/:page?/:limit?/:search?",{templateUrl:"views/recipes-list.html",controller:"RecipeListCtrl"}).when("/",{templateUrl:"views/recipes-list.html",controller:"RecipeListCtrl"}).otherwise({redirectTo:"/"})}]).controller("AppController",["$rootScope","$scope","$location","Recipe","authService","session","userRoles","authEvents",function(a,b,c,d,e,f,g,h){b.randomRecipes=[],d.randomList(8).success(function(a){b.randomRecipes=a}),b.account=null,b.userRoles=g,b.isAuthorized=e.isAuthorized,f.exists()&&(f.restore(),b.account=f.user),a.$on(h.loginSuccess,function(){b.account=f.user,c.path("/")}),a.$on(h.logoutSuccess,function(){b.account=null}),a.$on(h.loginFailed,function(){b.account=null,c.path("/login")}),a.$on(h.sessionTimeout,function(){b.account=null,c.path("/login")}),b.logout=function(){e.logout()}}]).run(["$rootScope","$route","$location","$routeParams",function(a,b,c){console.log("run app"),a.$on("$viewContentLoaded",function(){console.log("$viewContentLoaded")});var d=c.path;c.path=function(e,f){if(f===!1)var g=b.current,h=a.$on("$locationChangeSuccess",function(){b.current=g,h()});return d.apply(c,[e])}}]),angular.module("happyChiefApp").service("Recipe",["$http",function(a){return{get:function(b){return a.get("/recipes/"+b)},save:function(b){return b._id?a.put("/recipes/"+b._id,b):a.post("/recipes",b)},remove:function(b){return a.delete("/recipes/"+b)},randomList:function(b){return a({url:"/recipes/random/"+(b||5),method:"GET"})},getList:function(b){return a({url:"/recipes",method:"GET",params:b})}}}]),angular.module("happyChiefApp").controller("CardsContainerController",["$scope","$attrs","$parse","$interpolate","$routeParams","$location","$sanitize",function(a,b,c,d,e,f){var g=this;if("undefined"!=typeof b.sortDefault){var h=b.sortDefault.split(" ");a.sortField=h[0],a.sortOrder=2==h.length?h[1]:"asc"}else a.sortField=!1,a.sortOrder=!1;a.paginations="undefined"!=typeof b.paginations?b.paginations.split(","):[20,50,100],a.totalItems=0,a.currentPage=e.page?e.page:1,a.maxSize=5,a.itemsPerPage=e.limit?e.limit:20,a.skip=(a.currentPage-1)*a.itemsPerPage,a.hidePagination=!0,a.havePicture=!1,a.totalPages=1,a.search=e.search?e.search:"",a.onChangeItemsPerPage=function(b){a.itemsPerPage=b,a.currentPage=1,g.setPath(),g.loadList()},this.loadList=function(){var b={limit:a.itemsPerPage,skip:a.skip,search:a.search,sortOrder:a.sortOrder,sortField:a.sortField,havePicture:a.havePicture};b=angular.extend(b,a.parameters||{}),a.loader(b).success(function(b){a.list1=[],a.list2=[];for(var c=0;c<b.data.length;c++)c%2==0?a.list1.push(b.data[c]):a.list2.push(b.data[c]);a.totalItems=b.maxLength,a.totalPages=Math.ceil(b.maxLength/a.itemsPerPage),a.showPagination=b.maxLength>a.itemsPerPage})},this.setPath=function(){f.path(a.href.replace("#","")+"/"+a.currentPage+"/"+a.itemsPerPage+(a.search?"/"+a.search:""),!1)},a.sanitize=function(a){var b="-",c=a.trim().replace(/ /g,b);c=encodeURIComponent(c),c=c.replace(/(%C3%A9)|(%C3%A8)|(%C3%AA)|(%C3%AB)/g,"e"),c=c.replace(/(%C3%A0)|(%C3%A4)|(%C3%A2)/g,"a"),c=c.replace(/(%C3%B9)|(%C3%BC)|(%C3%BB)/g,"u"),c=c.replace(/(%C3%BF)/g,"y"),c=c.replace(/(%C3%B2)|(%C3%B6)|(%C3%B4)/g,"o"),c=c.replace(/(%C3%A7)/g,"c"),c=c.replace(/%[A-F0-9]{0,2}/g,"");var d=new RegExp('/\\\\|\\/|\\||\\:|\\?|\\*|"|<|>|[[:cntrl:]]/',"g");return c=c.replace(d,b),c=c.replace(/[~'!\.]/g,""),c=c.replace(/--/g,"-"),c.toLowerCase()},a.onSelectPage=function(b){a.currentPage=b,a.skip=(a.currentPage-1)*a.itemsPerPage,g.setPath(),g.loadList()},a.$parent.$watch("search",function(){a.currentPage=1,a.search=a.$parent.search||"",a.havePicture=a.$parent.havePicture||"",a.skip=(a.currentPage-1)*a.itemsPerPage,g.loadList()}),a.$parent.$watch("havePicture",function(){a.currentPage=1,a.search=a.$parent.search||"",a.havePicture=a.$parent.havePicture||"",a.skip=(a.currentPage-1)*a.itemsPerPage,g.loadList()}),a.$watch("parameters",function(){g.loadList()})}]).controller("CardController",["$scope","$attrs",function(){}]).directive("cardsContainer",["$parse",function(){return{restrict:"EA",controller:"CardsContainerController",templateUrl:"views/recipe/cards-container.html",transclude:!0,scope:{href:"@",loader:"=",parameters:"="},replace:!0,link:function(){}}}]).directive("card",["$parse",function(){return{restrict:"EA",controller:"CardController",templateUrl:"views/recipe/card.html",transclude:!0,scope:{href:"@",item:"="},replace:!0,link:function(){}}}]),angular.module("happyChiefApp").controller("RecipeListCtrl",["$scope","Recipe",function(a,b){console.log("Recipes list"),a.loader=function(a){return console.log(a),b.getList(a).error(function(a){console.log(a)})}}]),angular.module("happyChiefApp").controller("RecipeCtrl",["$scope","$routeParams","Recipe",function(a,b,c){a.steps={},a.sanitize=function(a){return a.replace("<br />","").replace(/<br \/>$/,"")},b.id&&c.get(b.id).success(function(b){a.data=b,a.now=new Date;for(var c in a.data.ingredients){var d=a.data.ingredients[c];"undefined"==typeof a.steps[d.step]&&(a.steps[d.step]=[]),a.steps[d.step].push(d)}})}]),angular.module("happyChiefApp").directive("imageonload",function(){return{restrict:"A",link:function(a,b){b.bind("load",function(){b.addClass("loaded")})}}}),angular.module("happyChiefApp").controller("LoginCtrl",["$rootScope","$scope","$routeParams","$location","authService","authEvents","session",function(a,b,c,d,e,f,g){if(b.credentials={},c.json){var h=JSON.parse(c.json);g.create(h),a.$broadcast(f.loginSuccess),d.path("/")}b.login=function(){return delete b.messageError,b.mail=$("#credential-mail").val(),b.password=$("#credential-password").val(),""==b.credentials.mail||""==b.credentials.password?void(b.messageError="Veuillez saisir votre e-mail et votre mot de passe pour vous connecter"):void e.login(b.credentials).then(function(){a.$broadcast(f.loginSuccess)},function(){a.$broadcast(f.loginFailed),b.messageError="Votre e-mail et mot de passe ne correspond à aucun compte utilisateur"})}}]),angular.module("happyChiefApp").controller("SignupCtrl",["$scope","authService","authEvents",function(a,b,c){a.credentials={},a.signup=function(){return delete a.messageError,""==a.credentials.email||""==a.credentials.password||a.credentials.name||a.credentials.firstName?void(a.messageError="Veuillez saisir les informations demandées par le formulaire"):void b.login(a.credentials).then(function(){$rootScope.$broadcast(c.loginSuccess)},function(){$rootScope.$broadcast(c.loginFailed),a.messageError="Une erreur est survenue lors de la création de votre compte"})}}]),angular.module("happyChiefApp").service("User",function(){}),angular.module("happyChiefApp").service("authService",["$rootScope","$http","session","authEvents",function(a,b,c,d){return{login:function(a){return b.post("/login",a).success(function(a){c.create(a)}).error(function(){c.destroy()})},signup:function(a){return b.post("/signup",a).success(function(a){c.create(a)}).error(function(){c.destroy()})},logout:function(){return a.$broadcast(d.logoutSuccess),b.post("/logout").success(function(){c.destroy()}).error(function(){c.destroy()})},isAuthenticated:function(){return c.exists()},isRoot:function(){return c.user.root}}}]),angular.module("happyChiefApp").constant("authEvents",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("userRoles",{root:"root",user:"user"}),angular.module("happyChiefApp").factory("authInterceptor",["$rootScope","$q","$window","authEvents",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},responseError:function(c){return 401===c.status&&a.$broadcast(d.notAuthenticated,c),403===c.status&&a.$broadcast(d.notAuthorized,c),(419===c.status||440===c.status)&&a.$broadcast(d.sessionTimeout,c),b.reject(c)}}}]),angular.module("happyChiefApp").service("session",["$window","User",function(a){return this.create=function(b){a.sessionStorage.token=b.token,a.sessionStorage.user=JSON.stringify(b.user),this.user=b.user},this.setUser=function(b){a.sessionStorage.user=JSON.stringify(b),this.user=b},this.destroy=function(){delete a.sessionStorage.token,delete a.sessionStorage.user,this.user=null,this.root=null},this.restore=function(){try{this.user=JSON.parse(a.sessionStorage.user),this.root=a.sessionStorage.user.root}catch(b){}},this.exists=function(){return!(!a.sessionStorage.token||!a.sessionStorage.user)},this}]);